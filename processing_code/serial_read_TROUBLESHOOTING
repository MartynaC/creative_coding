import processing.serial.*;

Serial port;
int analogRead = 0;

void setup() {
  size(800, 600);
  println("Dostępne porty:");
  println(Serial.list());

  // Spróbuj automatycznie znaleźć sensowny port (USB, nie Bluetooth)
  String[] ports = Serial.list();
  int chosen = -1;
  for (int i = 0; i < ports.length; i++) {
    String p = ports[i].toLowerCase();
    boolean looksLikeUsb =
      p.contains("usbmodem") || p.contains("usbserial") ||  // macOS
      p.matches(".*com\\d+.*") ||                           // Windows
      p.contains("ttyacm") || p.contains("ttyusb");         // Linux

    boolean looksLikeBluetooth =
      p.contains("bluetooth");

    if (looksLikeUsb && !looksLikeBluetooth) {
      chosen = i;
      break;
    }
  }

  // Fallback: jeśli nie znaleziono, bierz pierwszy na liście i daj komunikat
  if (chosen == -1 && ports.length > 0) {
    println("Nie znaleziono typowego portu USB. Biorę pierwszy z listy (może być zły): " + ports[0]);
    chosen = 0;
  }

  if (chosen == -1) {
    println("Brak portów! Sprawdź kabel/sterowniki i spróbuj ponownie.");
    exit();
    return;
  }

  println("Łączę z portem: " + ports[chosen]);
  port = new Serial(this, ports[chosen], 9600);

  // Czyść ewentualny „śmietnik” z bufora i czekaj na linie zakończone '\n'
  port.clear();
  port.bufferUntil('\n');

  background(0);
}

void draw() {
  float s = map(analogRead, 0, 1023, 50, 400);
  fill(100, 200, 255, 150);
  noStroke();
  ellipse(width/2, height/2, s, s);

  fill(0, 20);
  rect(0, 0, width, height);
}

// Odbiór linii zakończonej '\n' (Arduino println dodaje \r\n — to OK)
void serialEvent(Serial p) {
  String data = p.readStringUntil('\n');
  if (data != null) {
    data = trim(data);  // usuwa też \r
    try {
      analogRead = int(data);
    } catch (Exception e) {
      // pomiń uszkodzoną linię
    }
  }
}
